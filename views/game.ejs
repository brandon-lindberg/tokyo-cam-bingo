<!DOCTYPE html>
<html>
<head>
  <title>Tokyo Cam Bingo - <%= game.code %></title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/game.js"></script>
</head>
<body>
  <h1>Game: <%= game.code %> | Rules: <%= game.rules.winConditions && game.rules.winConditions.length > 0 ? game.rules.winConditions.join(', ') : 'None' %></h1>
  
  <h2>Leaderboard</h2>
  <table id="leaderboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Player</th>
        <th>Score (Lines)</th>
        <th>Stamped Tiles</th>
      </tr>
    </thead>
    <tbody>
      <!-- Populated by JS -->
    </tbody>
  </table>
  
  <% players.forEach(player => { %>
    <h2><%= player.name %>'s Card <%= player.isHost ? '(Host)' : '' %></h2>
    <table id="card-<%= player.id %>">
      <% player.card.forEach((row, r) => { %>
        <tr>
          <% row.forEach((tile, c) => { %>
            <td class="<%= tile.stamped ? 'stamped' : '' %>" data-player="<%= player.id %>" data-row="<%= r %>" data-col="<%= c %>">
              <%= tile.item %>
            </td>
          <% }) %>
        </tr>
      <% }) %>
    </table>
    
    <% if (currentPlayer.isHost) { %>
      <h3>Re-roll for <%= player.name %></h3>
      <button onclick="enterRerollMode('<%= player.id %>', '<%= game.code %>', '<%= player.name %>')">Enter Re-roll Mode</button>
      <div id="reroll-mode-<%= player.id %>" style="display: none;">
        <select id="reroll-type-<%= player.id %>" onchange="handleTypeChange('<%= player.id %>')">
          <option value="">Select Type</option>
          <option value="tile">Tile</option>
          <option value="row">Row</option>
          <option value="column">Column</option>
          <option value="diagonal">Diagonal</option>
          <option value="card">Whole Card</option>
        </select>
        <p id="selection-instruct-<%= player.id %>">Click on the card to select the area.</p>
        <button onclick="confirmReroll('<%= player.id %>')">Confirm Re-roll</button>
        <button onclick="exitRerollMode('<%= player.id %>')">Cancel</button>
      </div>
    <% } %>
  <% }) %>
  
  <script>
    const socket = io();
    window.socket = socket;  // Make socket global for game.js
    const code = '<%= game.code %>';
    const playerName = '<%= currentPlayer.name %>';
    socket.emit('join_room', { code, playerName });
    
    // Update state
    socket.on('update_state', (players) => {
      players.forEach(p => {
        const table = document.getElementById(`card-${p.id}`);
        p.card.forEach((row, r) => {
          row.forEach((tile, c) => {
            const td = table.rows[r].cells[c];
            td.textContent = tile.item;
            td.classList.toggle('stamped', tile.stamped);
          });
        });
      });
      updateLeaderboard(players);
    });
    
    socket.on('win', ({ playerName }) => {
      alert(`${playerName} wins!`);
    });
    
    // Stamp on click (only own card)
    document.querySelectorAll('td[data-player="<%= currentPlayer.id %>"]').forEach(td => {
      td.addEventListener('click', () => {
        if (td.closest('table').classList.contains('reroll-mode')) return;  // Prevent stamp in re-roll mode
        const row = td.dataset.row;
        const col = td.dataset.col;
        socket.emit('stamp', { code, playerId: '<%= currentPlayer.id %>', row, col });
      });
    });
  </script>
</body>
</html>