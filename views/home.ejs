<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= t('common.appName') %></title>

  <!-- PWA Meta Tags -->
  <meta name="description" content="<%= t('common.tagline') %>">
  <meta name="theme-color" content="#FF69B4">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TCB">
  <meta name="csrf-token" content="<%= csrfToken %>">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css?v=<%= assetVersion %>">
  <link rel="stylesheet" href="/css/timer-picker.css?v=<%= assetVersion %>">
  <script src="/js/pwa-install.js?v=<%= assetVersion %>" defer></script>
  <script src="/js/splash.js?v=<%= assetVersion %>" defer></script>
  <script src="/js/timer-picker.js?v=<%= assetVersion %>"></script>
</head>
<body class="splash-active has-global-top-bar" data-asset-version="<%= assetVersion %>" data-sw-enabled="<%= enableServiceWorker %>" data-locale="<%= locale %>">
  <div class="global-top-bar">
    <div class="top-bar-left">
      <a id="top-bar-back" href="#" onclick="backToHome(); return false;" style="visibility: hidden; pointer-events: none;">‚Üê <%= t('actions.backToHome') %></a>
    </div>
    <div class="top-bar-right">
      <%- include('partials/locale-switcher') %>
    </div>
  </div>
  <div id="splash-screen" class="splash-screen" role="presentation" aria-hidden="true">
    <img src="/images/yabai_sutudios.png?v=<%= assetVersion %>" alt="Yabai Sutudios splash">
  </div>
  <div class="container welcome-container" style="margin: 0 auto;">
    <div id="welcome-content">
      <h1><%= t('home.welcomeHeading') %></h1>
      <div class="button-group">
        <button onclick="showHostForm()"><%= t('actions.hostGame') %></button>
        <button onclick="showJoinForm()"><%= t('actions.joinGame') %></button>
      </div>
      <div class="rulebook-trigger">
        <button type="button" id="rulebook-open"><%= t('home.ruleBook') %></button>
      </div>
      <div style="text-align: center; margin-top: 1rem;">
        <a href="/card-builder" style="color: #00BFFF; text-decoration: none; font-size: 1rem;">
          <%= t('home.createCustomCardLink') %>
        </a>
      </div>
      <div style="text-align: center; margin-top: 2rem;">
        <img src="/tokyo-cam-bingo.png?v=<%= assetVersion %>" alt="Tokyo Cam Bingo" style="max-width: 300px; width: 100%; height: auto;">
      </div>
    </div>
    
    <div id="host-form" style="display: none;">
      <div style="height: 1.5rem;"></div>
      <h2><%= t('home.hostFormTitle') %></h2>
      <form action="/create" method="POST" class="create-game-form">
        <input type="hidden" name="csrfToken" value="<%= csrfToken %>">

        <!-- Player Info Section -->
        <div class="form-section">
          <label class="form-label"><%= t('home.hostNameLabel') %></label>
          <input type="text" name="hostName" class="form-input" placeholder="<%= t('home.hostNamePlaceholder') %>" required>
        </div>

        <!-- Game Mode Section -->
        <div class="form-section">
          <label class="form-label"><%= t('home.gameModeLabel') %></label>
          <div class="mode-selector">
            <label class="mode-option">
              <input type="radio" name="modeType" value="REGULAR" checked onchange="toggleHostColorSelection()">
              <div class="mode-card">
                <div class="mode-title"><%= t('home.modeRegularTitle') %></div>
                <div class="mode-description"><%= t('home.modeRegularDescription') %></div>
              </div>
            </label>
            <label class="mode-option">
              <input type="radio" name="modeType" value="VS" id="vsMode" onchange="toggleHostColorSelection()">
              <div class="mode-card">
                <div class="mode-title"><%= t('home.modeVsTitle') %></div>
                <div class="mode-description"><%= t('home.modeVsDescription') %></div>
              </div>
            </label>
          </div>
        </div>

        <!-- Color Selection (VS Mode Only) -->
        <div id="host-color-selection" class="form-section" style="display: none;">
          <label class="form-label"><%= t('home.modeColorsLabel') %></label>
          <select id="hostColor" name="hostColor" class="form-select">
            <option value=""><%= t('home.colorPlaceholder') %></option>
            <option value="RED">üî¥ <%= t('colors.red') %></option>
            <option value="BLUE">üîµ <%= t('colors.blue') %></option>
            <option value="GREEN">üü¢ <%= t('colors.green') %></option>
            <option value="YELLOW">üü° <%= t('colors.yellow') %></option>
            <option value="PURPLE">üü£ <%= t('colors.purple') %></option>
            <option value="ORANGE">üü† <%= t('colors.orange') %></option>
            <option value="PINK">ü©∑ <%= t('colors.pink') %></option>
            <option value="CYAN">üîµ <%= t('colors.cyan') %></option>
          </select>
        </div>

        <!-- Bingo Card Section -->
        <div class="form-section" id="bingo-card-section">
          <label class="form-label" for="bingoCardPreset"><%= t('home.bingoCardLabel') %></label>
          <select id="bingoCardPreset" name="bingoCardPreset" class="form-select">
            <option value="default" selected><%= t('home.bingoDefaultOption') %></option>
            <option value="category"><%= t('home.bingoCategoryOption') %></option>
            <option value="game"><%= t('home.bingoGameOption') %></option>
            <option value="all"><%= t('home.bingoAllOption') %></option>
          </select>

          <div id="bingo-category-wrapper" class="preset-detail">
            <label class="form-sub-label" for="bingoCategory"><%= t('home.bingoCategoryLabel') %></label>
            <select id="bingoCategory" name="bingoCategory" class="form-select" disabled>
              <option value=""><%= t('home.loadingCategories') %></option>
            </select>
          </div>

          <div id="bingo-game-wrapper" class="preset-detail">
            <label class="form-sub-label" for="bingoGame"><%= t('home.bingoGameLabel') %></label>
            <select id="bingoGame" name="bingoGame" class="form-select" disabled>
              <option value=""><%= t('home.loadingGames') %></option>
            </select>
          </div>

          <div id="bingo-card-helper" class="helper-text">
            <%= t('home.bingoHelperDefault') %>
          </div>

          <button type="button" onclick="toggleCustomCardInput(event)" class="secondary-button preset-secondary">
            <%= t('home.customCardButton') %>
          </button>
          <div id="custom-card-input-section" style="display: none; margin-top: 1rem;">
            <input type="text" id="customCardCode" name="customCardCode" class="form-input" placeholder="<%= t('home.customCardPlaceholder') %>" maxlength="6" autocomplete="off">
            <div id="custom-card-info" class="helper-text muted"></div>
          </div>
        </div>

        <!-- Game Options Section -->
        <div class="form-section">
          <label class="form-label"><%= t('home.gameOptionsLabel') %></label>
          <div class="options-grid">
            <label class="option-checkbox">
              <input type="checkbox" id="flagsEnabled" name="flagsEnabled" value="true" checked>
              <span class="checkbox-label">
                <span class="checkbox-title"><%= t('home.flagOptionTitle') %></span>
                <span class="checkbox-description"><%= t('home.flagOptionDescription') %></span>
              </span>
            </label>
            <label class="option-checkbox">
              <input type="checkbox" id="rerollsEnabled" name="rerollsEnabled" value="true" checked>
              <span class="checkbox-label">
                <span class="checkbox-title"><%= t('home.rerollOptionTitle') %></span>
                <span class="checkbox-description"><%= t('home.rerollOptionDescription') %></span>
              </span>
            </label>
          </div>
        </div>

        <!-- Timer Section -->
        <div class="form-section">
          <label class="form-label"><%= t('home.timerSectionLabel') %></label>
          <label class="option-checkbox">
            <input type="checkbox" id="timerEnabled" name="timerEnabled" value="true" onchange="toggleTimerSettings()">
            <span class="checkbox-label">
              <span class="checkbox-title"><%= t('home.timerEnableLabel') %></span>
              <span class="checkbox-description"><%= t('home.timerDescription') %></span>
            </span>
          </label>

          <div id="timer-settings-section" class="timer-settings-expanded">
            <!-- Timer Picker -->
            <div id="timer-picker-container"></div>

            <!-- Quick Presets -->
            <div class="timer-presets">
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(300)"><%= t('home.timerPresetMinutes', { value: 5 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(600)"><%= t('home.timerPresetMinutes', { value: 10 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(900)"><%= t('home.timerPresetMinutes', { value: 15 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(1200)"><%= t('home.timerPresetMinutes', { value: 20 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(1800)"><%= t('home.timerPresetMinutes', { value: 30 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(2700)"><%= t('home.timerPresetMinutes', { value: 45 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(3600)"><%= t('home.timerPresetHours', { value: 1 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(7200)"><%= t('home.timerPresetHours', { value: 2 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(14400)"><%= t('home.timerPresetHours', { value: 4 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(21600)"><%= t('home.timerPresetHours', { value: 6 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(28800)"><%= t('home.timerPresetHours', { value: 8 }) %></button>
              <button type="button" class="timer-preset-btn" onclick="setTimerPreset(43200)"><%= t('home.timerPresetHours', { value: 12 }) %></button>
            </div>

            <!-- Hidden input to store timer duration in seconds -->
            <input type="hidden" id="timerDuration" name="timerDuration" value="300">
          </div>
        </div>

        <!-- CAPTCHA Section -->
        <div class="form-section">
          <label class="form-label"><%= t('home.captchaLabel') %></label>
          <div class="captcha-wrapper" style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
            <span id="create-captcha-question" class="captcha-question" style="font-weight:600;">
              <%= createCaptchaQuestion || t('home.captchaQuestionFallback') %>
            </span>
            <button type="button" class="secondary-button" id="refresh-create-captcha" onclick="refreshCreateCaptcha(event)" style="padding:0.4rem 0.75rem;">
              ‚Üª
            </button>
          </div>
          <input type="text" name="captchaAnswer" class="form-input" placeholder="<%= t('home.captchaAnswerPlaceholder') %>" required autocomplete="off">
          <p class="helper-text muted"><%= t('home.captchaHelper') %></p>
        </div>

        <!-- Win Conditions Section -->
        <div class="form-section">
          <label class="form-label"><%= t('home.winConditionsLabel') %></label>
          <div class="win-conditions-modern">
            <label class="win-option" data-modes="regular,vs">
              <input type="checkbox" id="row" name="winConditions" value="row">
              <span class="win-label"><%= t('home.winConditions.row') %></span>
            </label>
            <label class="win-option" data-modes="regular">
              <input type="checkbox" id="2rows" name="winConditions" value="2rows">
              <span class="win-label"><%= t('home.winConditions.twoRows') %></span>
            </label>
            <label class="win-option" data-modes="regular">
              <input type="checkbox" id="3rows" name="winConditions" value="3rows">
              <span class="win-label"><%= t('home.winConditions.threeRows') %></span>
            </label>
            <label class="win-option" data-modes="regular,vs">
              <input type="checkbox" id="column" name="winConditions" value="column">
              <span class="win-label"><%= t('home.winConditions.column') %></span>
            </label>
            <label class="win-option" data-modes="regular">
              <input type="checkbox" id="2columns" name="winConditions" value="2columns">
              <span class="win-label"><%= t('home.winConditions.twoColumns') %></span>
            </label>
            <label class="win-option" data-modes="regular">
              <input type="checkbox" id="3columns" name="winConditions" value="3columns">
              <span class="win-label"><%= t('home.winConditions.threeColumns') %></span>
            </label>
            <label class="win-option" data-modes="regular,vs">
              <input type="checkbox" id="diagonals" name="winConditions" value="diagonals">
              <span class="win-label"><%= t('home.winConditions.diagonals') %></span>
            </label>
            <label class="win-option" data-modes="regular">
              <input type="checkbox" id="full" name="winConditions" value="full">
              <span class="win-label"><%= t('home.winConditions.fullCard') %></span>
            </label>
            <label class="win-option" data-modes="regular,vs" id="most-squares-option">
              <input type="checkbox" id="most_squares" name="winConditions" value="most_squares">
              <span class="win-label"><%= t('home.winConditions.mostSquares') %></span>
            </label>
          </div>
        </div>

        <button type="submit" class="create-button"><%= t('actions.createGame') %></button>
      </form>
    </div>
    
    <div id="join-form" style="display: none;">
      <h2><%= t('home.joinFormTitle') %></h2>
      <form id="join-game-form" action="/join" method="POST">
        <input type="hidden" name="csrfToken" value="<%= csrfToken %>">
        <label class="form-label" for="join-code"><%= t('home.joinCodeLabel') %></label>
        <input type="password" id="join-code" name="code" placeholder="<%= t('home.joinCodePlaceholder') %>" required>
        <label class="form-label" for="join-name"><%= t('home.joinNameLabel') %></label>
        <input type="text" id="join-name" name="playerName" placeholder="<%= t('home.joinNamePlaceholder') %>" required>
        <div id="color-selection" style="display: none; margin: 1rem 0;">
          <label for="playerColor"><%= t('home.modeColorsLabel') %></label>
          <select id="playerColor" name="playerColor">
            <option value=""><%= t('home.colorPlaceholder') %></option>
            <option value="RED"><%= t('colors.red') %></option>
            <option value="BLUE"><%= t('colors.blue') %></option>
            <option value="GREEN"><%= t('colors.green') %></option>
            <option value="YELLOW"><%= t('colors.yellow') %></option>
            <option value="PURPLE"><%= t('colors.purple') %></option>
            <option value="ORANGE"><%= t('colors.orange') %></option>
            <option value="PINK"><%= t('colors.pink') %></option>
            <option value="CYAN"><%= t('colors.cyan') %></option>
          </select>
        </div>
        <button type="submit"><%= t('actions.joinGame') %></button>
      </form>
    </div>
  </div>

  <%
    const rulebook = t('home.rulebook');
    const ruleSections = (rulebook && rulebook.sections) || [];
  %>
  <div id="rulebook-modal" class="modal-overlay">
    <div class="modal-card rulebook-modal-card" role="dialog" aria-modal="true" aria-labelledby="rulebook-title">
      <div class="modal-header">
        <span aria-hidden="true">üìò</span>
        <h3 id="rulebook-title" class="modal-title" tabindex="-1"><%= (rulebook && rulebook.title) || t('home.ruleBook') %></h3>
      </div>
      <div class="rulebook-content">
        <% ruleSections.forEach((section, index) => { %>
          <section class="rulebook-section">
            <h4 class="rulebook-section-title"><%= section.title %></h4>
            <% if (section.description) { %>
              <p><%= section.description %></p>
            <% } %>
            <% if (Array.isArray(section.items) && section.items.length) { %>
              <ul class="rulebook-list">
                <% section.items.forEach((item) => { %>
                  <li>
                    <% if (item.label) { %>
                      <strong><%= item.label %><%= item.label.endsWith(':') ? '' : ':' %></strong>
                    <% } %>
                    <%= item.body %>
                  </li>
                <% }); %>
              </ul>
            <% } %>
          </section>
        <% }); %>
      </div>
      <div class="modal-actions">
        <button type="button" id="rulebook-close" class="btn btn-secondary"><%= (rulebook && rulebook.closeLabel) || t('actions.close') %></button>
      </div>
    </div>
  </div>

  <%- include('partials/i18n-script', { namespaces: ['home', 'alerts', 'notifications'] }) %>
  <script>
    // Clear any cached data on page load to prevent stale game states
    (function() {
      try {
        // Clear localStorage
        localStorage.clear();
        // Clear sessionStorage
        sessionStorage.clear();
      } catch (e) {
        console.warn('Could not clear storage:', e);
      }
    })();

    const translate = (key, vars) => (typeof window.t === 'function' ? window.t(key, vars) : key);

    async function refreshCreateCaptcha(event) {
      if (event && typeof event.preventDefault === 'function') {
        event.preventDefault();
      }
      const questionEl = document.getElementById('create-captcha-question');
      const refreshBtn = document.getElementById('refresh-create-captcha');
      if (!questionEl) return;
      try {
        if (refreshBtn) refreshBtn.disabled = true;
        const response = await fetch('/api/captcha/createGame');
        if (!response.ok) {
          throw new Error(translate('errors.generic'));
        }
        const data = await response.json();
        questionEl.textContent = data.question || translate('home.captchaQuestionFallback');
      } catch (error) {
        console.error('captcha refresh failed', error);
        questionEl.textContent = translate('home.captchaLoadError');
      } finally {
        if (refreshBtn) refreshBtn.disabled = false;
      }
    }

    // Timer picker instance
    let timerPicker = null;
    const timerPickerContainer = document.getElementById('timer-picker-container');
    const timerDurationInput = document.getElementById('timerDuration');

    if (timerDurationInput) {
      timerDurationInput.value = 300;
    }

    if (timerPickerContainer) {
      timerPickerContainer.addEventListener('timerPickerChange', function(event) {
        if (!event || !event.detail) return;
        const totalSeconds = event.detail.totalSeconds;
        if (typeof totalSeconds === 'number' && !Number.isNaN(totalSeconds)) {
          const hiddenInput = document.getElementById('timerDuration');
          if (hiddenInput) {
            hiddenInput.value = totalSeconds;
          }
        }
      });
    }

    const bingoPresetSelect = document.getElementById('bingoCardPreset');
    const bingoCategorySelect = document.getElementById('bingoCategory');
    const bingoGameSelect = document.getElementById('bingoGame');
    const bingoCategoryWrapper = document.getElementById('bingo-category-wrapper');
    const bingoGameWrapper = document.getElementById('bingo-game-wrapper');
    const bingoCardHelper = document.getElementById('bingo-card-helper');
    let bingoMetaCache = null;
    let bingoMetaRequest = null;

    function populateBingoSelect(selectEl, items, placeholder) {
      if (!selectEl) return;
      const previousValue = selectEl.value;
      selectEl.innerHTML = '';
      const placeholderOption = document.createElement('option');
      placeholderOption.value = '';
      placeholderOption.textContent = placeholder;
      placeholderOption.disabled = true;
      placeholderOption.selected = true;
      selectEl.appendChild(placeholderOption);

      (items || []).forEach(item => {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = `${item.label} (${item.count})`;
        selectEl.appendChild(option);
      });

      if (previousValue && (items || []).some(item => item.value === previousValue)) {
        selectEl.value = previousValue;
      } else {
        selectEl.value = '';
      }
    }

    function updateBingoHelper(meta) {
      if (!bingoCardHelper || !meta) return;
      const categoryCount = (meta.categories && meta.categories.length) || 0;
      const gameCount = (meta.games && meta.games.length) || 0;
      const minItems = meta.minItems || 25;
      bingoCardHelper.classList.remove('error');
      bingoCardHelper.textContent = translate('home.bingoHelperMeta', {
        categories: categoryCount,
        games: gameCount,
        min: minItems
      });
    }

    async function loadBingoMetadata() {
      if (bingoMetaCache) return bingoMetaCache;
      if (bingoMetaRequest) return bingoMetaRequest;

      bingoMetaRequest = fetch('/api/bingo-tasks/meta')
        .then(response => {
          if (!response.ok) {
            throw new Error(translate('errors.generic'));
          }
          return response.json();
        })
        .then(data => {
          bingoMetaCache = data;
          populateBingoSelect(bingoCategorySelect, data.categories, translate('home.bingoCategoryPlaceholder'));
          populateBingoSelect(bingoGameSelect, data.games, translate('home.bingoGamePlaceholder'));
          updateBingoHelper(data);
          return data;
        })
        .catch(error => {
          console.error('Unable to load bingo task metadata:', error);
          if (bingoCardHelper) {
            bingoCardHelper.textContent = translate('home.bingoHelperError');
            bingoCardHelper.classList.add('error');
          }
          throw error;
        })
        .finally(() => {
          bingoMetaRequest = null;
        });

      return bingoMetaRequest;
    }

    function handleBingoPresetChange() {
      const preset = bingoPresetSelect ? bingoPresetSelect.value : 'default';
      const showCategory = preset === 'category';
      const showGame = preset === 'game';
      const needsMetadata = preset === 'all' || showCategory || showGame;

      if (bingoCategoryWrapper) {
        bingoCategoryWrapper.style.display = showCategory ? 'block' : 'none';
      }
      if (bingoGameWrapper) {
        bingoGameWrapper.style.display = showGame ? 'block' : 'none';
      }

      if (bingoCategorySelect) {
        bingoCategorySelect.required = showCategory;
        bingoCategorySelect.disabled = !showCategory;
        if (!showCategory) {
          bingoCategorySelect.value = '';
        }
      }

      if (bingoGameSelect) {
        bingoGameSelect.required = showGame;
        bingoGameSelect.disabled = !showGame;
        if (!showGame) {
          bingoGameSelect.value = '';
        }
      }

      if (needsMetadata) {
        loadBingoMetadata().catch(() => {});
      }
    }

    function showHostForm() {
    document.getElementById('welcome-content').style.display = 'none';
    document.getElementById('host-form').style.display = 'block';
    document.getElementById('join-form').style.display = 'none';
    updateTopBarBack(true);

      // Initialize timer picker when showing host form
      if (!timerPicker) {
        setTimeout(() => {
          timerPicker = new TimerPicker('timer-picker-container');
          timerPicker.resetToDefault();
          updateTimerDurationInput();
          toggleTimerSettings();
          toggleHostColorSelection();
        }, 100);
      } else {
        timerPicker.resetToDefault();
        updateTimerDurationInput();
        toggleTimerSettings();
        toggleHostColorSelection();
      }
      handleBingoPresetChange();
      loadBingoMetadata().catch(() => {});
    }

    function showJoinForm() {
    document.getElementById('welcome-content').style.display = 'none';
    document.getElementById('join-form').style.display = 'block';
    document.getElementById('host-form').style.display = 'none';
    updateTopBarBack(true);
    }

    function backToHome() {
      document.getElementById('welcome-content').style.display = 'block';
    document.getElementById('host-form').style.display = 'none';
    document.getElementById('join-form').style.display = 'none';
    updateTopBarBack(false);
      if (timerPicker) {
        timerPicker.resetToDefault();
        updateTimerDurationInput();
        toggleTimerSettings();
        toggleHostColorSelection();
      }
    }

    function updateTopBarBack(show) {
      const link = document.getElementById('top-bar-back');
      if (!link) return;
      link.style.visibility = show ? 'visible' : 'hidden';
      link.style.pointerEvents = show ? 'auto' : 'none';
    }

    function toggleCustomCardInput(evt) {
      const inputSection = document.getElementById('custom-card-input-section');
      const button = evt && evt.target ? evt.target : document.querySelector('.preset-secondary');

      if (inputSection.style.display === 'none') {
        inputSection.style.display = 'block';
        button.textContent = 'Use Default Card';
      } else {
        inputSection.style.display = 'none';
        button.textContent = 'Use Custom Card (Optional)';
        // Clear the input and info when hiding
        document.getElementById('customCardCode').value = '';
        document.getElementById('custom-card-info').textContent = '';
      }
    }

    function toggleHostColorSelection() {
      const vsModeChecked = document.getElementById('vsMode').checked;
      const colorSelection = document.getElementById('host-color-selection');
      const colorSelect = document.getElementById('hostColor');
      const timerEnabled = document.getElementById('timerEnabled').checked;
      const mostSquaresOption = document.getElementById('most-squares-option');
      const mostSquaresCheckbox = document.getElementById('most_squares');

      // Toggle color selection
      if (vsModeChecked) {
        colorSelection.style.display = 'block';
        colorSelect.required = true;
      } else {
        colorSelection.style.display = 'none';
        colorSelect.required = false;
      }

      // Filter win conditions based on mode
      const mode = vsModeChecked ? 'vs' : 'regular';
      const winOptions = document.querySelectorAll('.win-option');

      winOptions.forEach(option => {
        const modes = option.getAttribute('data-modes');
        const checkbox = option.querySelector('input[type="checkbox"]');

        if (modes.includes(mode)) {
          option.style.display = 'block';
        } else {
          option.style.display = 'none';
          // Uncheck hidden options
          checkbox.checked = false;
        }
      });

      if (!vsModeChecked && mostSquaresOption) {
        if (timerEnabled) {
          mostSquaresOption.style.display = 'block';
          if (mostSquaresCheckbox) {
            mostSquaresCheckbox.checked = true;
          }
        } else {
          mostSquaresOption.style.display = 'none';
          if (mostSquaresCheckbox) mostSquaresCheckbox.checked = false;
        }
      }
    }

    // Check custom card code when entered
    const customCardCodeInput = document.getElementById('customCardCode');
    const customCardInfo = document.getElementById('custom-card-info');

    if (customCardCodeInput) {
      customCardCodeInput.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase();
      });

      customCardCodeInput.addEventListener('blur', async function() {
        const code = this.value.trim().toUpperCase();
        customCardInfo.textContent = '';
        customCardInfo.style.color = '#666';

        if (code.length === 6) {
          try {
            const response = await fetch(`/api/card-collections/${code}`);
            if (response.ok) {
              const cardData = await response.json();
              customCardInfo.textContent = `‚úì "${cardData.name}" loaded (${cardData.itemCount} items)`;
              customCardInfo.style.color = '#10B981';
            } else {
              customCardInfo.textContent = '‚úó Custom card not found';
              customCardInfo.style.color = '#EF4444';
            }
          } catch (err) {
            console.error('Failed to fetch card:', err);
            customCardInfo.textContent = '‚úó Error loading card';
            customCardInfo.style.color = '#EF4444';
          }
        }
      });
    }

    // Check game mode when code is entered
    const joinCodeInput = document.getElementById('join-code');
    const colorSelection = document.getElementById('color-selection');
    const playerColorSelect = document.getElementById('playerColor');
    if (playerColorSelect) {
      playerColorSelect.required = false;
    }
    if (joinCodeInput) {
      joinCodeInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
    }

    joinCodeInput.addEventListener('blur', async function() {
      const code = this.value.trim().toUpperCase();
      if (code.length === 6) {
        try {
          const response = await fetch(`/game-info/${code}`);
          if (response.ok) {
            const gameInfo = await response.json();
            if (gameInfo.mode === 'VS') {
              // Show color selection and filter available colors
              colorSelection.style.display = 'block';
              playerColorSelect.required = true;

              // Disable already taken colors
              const allColors = ['RED', 'BLUE', 'GREEN', 'YELLOW', 'PURPLE', 'ORANGE', 'PINK', 'CYAN'];
              const takenColors = gameInfo.takenColors || [];

              Array.from(playerColorSelect.options).forEach(option => {
                if (option.value && takenColors.includes(option.value)) {
                  option.disabled = true;
                  option.textContent = option.textContent + ' (taken)';
                } else if (option.value) {
                  option.disabled = false;
                  option.textContent = option.value.charAt(0) + option.value.slice(1).toLowerCase();
                }
              });
            } else {
              colorSelection.style.display = 'none';
              playerColorSelect.required = false;
              playerColorSelect.value = '';
            }
          }
        } catch (err) {
          console.error('Failed to fetch game info:', err);
        }
      }
    });

    function initRulebookModal() {
      const modal = document.getElementById('rulebook-modal');
      const openBtn = document.getElementById('rulebook-open');
      const closeBtn = document.getElementById('rulebook-close');
      if (!modal || !openBtn || !closeBtn) return;

      const open = () => {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
        const modalCard = modal.querySelector('.rulebook-modal-card');
        if (modalCard) {
          modalCard.scrollTop = 0;
          const raf = window.requestAnimationFrame || ((cb) => setTimeout(cb, 16));
          raf(() => { modalCard.scrollTop = 0; });
        }
        const heading = document.getElementById('rulebook-title');
        if (heading) heading.focus();
      };

      const close = () => {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
        openBtn.focus();
      };

      openBtn.addEventListener('click', open);
      closeBtn.addEventListener('click', close);
      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          close();
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modal.style.display === 'flex') {
          close();
        }
      });
    }

    // Timer Settings Functions
    function toggleTimerSettings() {
      const enabled = document.getElementById('timerEnabled').checked;
      const settingsSection = document.getElementById('timer-settings-section');
      const mostSquaresOption = document.getElementById('most-squares-option');
      const mostSquaresCheckbox = document.getElementById('most_squares');
      const vsModeChecked = document.getElementById('vsMode').checked;

      if (settingsSection) {
        const raf = window.requestAnimationFrame || ((cb) => setTimeout(cb, 16));

        if (enabled) {
          settingsSection.style.display = 'block';
          // Allow layout to update before triggering transition
          raf(() => settingsSection.classList.add('show'));
        } else {
          settingsSection.classList.remove('show');
          settingsSection.style.display = 'none';
        }
      }

      if (enabled) {
        if (timerPicker) {
          const raf = window.requestAnimationFrame || ((cb) => setTimeout(cb, 16));
          raf(() => timerPicker.handleResize());
        }
        // Update the hidden input with current timer value
        updateTimerDurationInput();

        if (!vsModeChecked && mostSquaresOption) {
          mostSquaresOption.style.display = 'block';
          if (mostSquaresCheckbox) {
            mostSquaresCheckbox.checked = true;
          }
        }
      } else if (!vsModeChecked && mostSquaresOption && mostSquaresCheckbox) {
          mostSquaresOption.style.display = 'none';
          mostSquaresCheckbox.checked = false;
      }
    }

    function setTimerPreset(seconds) {
      if (timerPicker) {
        timerPicker.setValue(seconds);
        updateTimerDurationInput();
      }
    }

    function updateTimerDurationInput() {
      if (timerPicker) {
        const duration = timerPicker.getValue();
        document.getElementById('timerDuration').value = duration;
      }
    }

    // Update timer duration when form is submitted
    document.addEventListener('DOMContentLoaded', function() {
      const createForm = document.querySelector('.create-game-form');
      if (createForm) {
        createForm.addEventListener('submit', function(e) {
          const timerEnabled = document.getElementById('timerEnabled').checked;
          const vsModeChecked = document.getElementById('vsMode').checked;
          const mostSquaresCheckbox = document.getElementById('most_squares');
          if (timerEnabled) {
            updateTimerDurationInput();
            if (!vsModeChecked && mostSquaresCheckbox) {
              mostSquaresCheckbox.checked = true;
            }
          }
        });
      }

      toggleHostColorSelection();
      toggleTimerSettings();
      if (bingoPresetSelect) {
        bingoPresetSelect.addEventListener('change', handleBingoPresetChange);
        handleBingoPresetChange();
      }
      initRulebookModal();
    });
  </script>
</body>
</html>
