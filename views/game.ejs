<!DOCTYPE html>
<html>
<head>
  <title>Tokyo Cam Bingo - <%= game.code %></title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/game.js"></script>
</head>
<body data-code="<%= game.code %>" data-player-name="<%= currentPlayer.name %>" data-is-host="<%= currentPlayer.isHost %>" data-game-status="<%= game.status %>">
  <h1>Game: <%= game.code %> | Rules: <%= game.rules.winConditions && game.rules.winConditions.length > 0 ? game.rules.winConditions.join(', ') : 'None' %></h1>
  
  <div id="game-over" style="display: none; font-size: 24px; color: red; margin-bottom: 20px;">
    Game Over! <span id="winner-name"></span> wins!
  </div>
  <% if (currentPlayer.isHost) { %>
    <div id="host-options" style="display: none; margin-bottom: 20px;">
      <button onclick="startNewGame('<%= game.code %>')">Start New Game</button>
      <button onclick="location.href = '/'">Exit to Home</button>
    </div>
  <% } %>
  
  <h2>Leaderboard</h2>
  <table id="leaderboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Player</th>
        <th>Score (Lines)</th>
        <th>Stamped Tiles</th>
      </tr>
    </thead>
    <tbody>
      <!-- Populated by JS -->
    </tbody>
  </table>
  
  <% players.forEach(player => { %>
    <h2><%= player.name %>'s Card <%= player.isHost ? '(Host)' : '' %></h2>
    <table id="card-<%= player.id %>">
      <% player.card.forEach((row, r) => { %>
        <tr>
          <% row.forEach((tile, c) => { %>
            <td class="<%= tile.stamped ? 'stamped' : '' %>" data-player="<%= player.id %>" data-row="<%= r %>" data-col="<%= c %>">
              <%= tile.item %>
            </td>
          <% }) %>
        </tr>
      <% }) %>
    </table>
    
    <% if (currentPlayer.isHost) { %>
      <h3>Re-roll for <%= player.name %></h3>
      <button onclick="enterRerollMode('<%= player.id %>', '<%= game.code %>', '<%= player.name %>')">Enter Re-roll Mode</button>
      <div id="reroll-mode-<%= player.id %>" style="display: none;">
        <select id="reroll-type-<%= player.id %>" onchange="handleTypeChange('<%= player.id %>')">
          <option value="">Select Type</option>
          <option value="tile">Tile</option>
          <option value="row">Row</option>
          <option value="column">Column</option>
          <option value="diagonal">Diagonal</option>
          <option value="card">Whole Card</option>
        </select>
        <p id="selection-instruct-<%= player.id %>">Click on the card to select the area.</p>
        <button onclick="confirmReroll('<%= player.id %>')">Confirm Re-roll</button>
        <button onclick="exitRerollMode('<%= player.id %>')">Cancel</button>
      </div>
    <% } %>
  <% }) %>
  
  <script>
    const socket = io();
    window.socket = socket;
    const code = document.body.dataset.code;
    const playerName = document.body.dataset.playerName;
    const isHost = document.body.dataset.isHost === 'true';
    let isGameOver = document.body.dataset.gameStatus === 'ended';
    socket.emit('join_room', { code, playerName });
    
    // Update state
    socket.on('update_state', (data) => {
      const { game, players } = data;
      players.forEach(p => {
        const table = document.getElementById(`card-${p.id}`);
        p.card.forEach((row, r) => {
          row.forEach((tile, c) => {
            const td = table.rows[r].cells[c];
            td.textContent = tile.item;
            td.classList.toggle('stamped', tile.stamped);
          });
        });
      });
      updateLeaderboard(players);
      
      if (game.status === 'ended' && !isGameOver) {
        isGameOver = true;
        document.getElementById('game-over').style.display = 'block';
        document.getElementById('winner-name').textContent = game.winner;
        if (isHost) {
          document.getElementById('host-options').style.display = 'block';
        }
      } else if (game.status === 'active' && isGameOver) {
        isGameOver = false;
        document.getElementById('game-over').style.display = 'none';
        if (isHost) {
          document.getElementById('host-options').style.display = 'none';
        }
      }
    });
    
    socket.on('win', ({ playerName }) => {
      alert(`${playerName} wins!`);
    });
    
    // Stamp on click (only own card)
    document.querySelectorAll('td[data-player="<%= currentPlayer.id %>"]').forEach(td => {
      td.addEventListener('click', () => {
        if (isGameOver || td.closest('table').classList.contains('reroll-mode')) return;
        const row = td.dataset.row;
        const col = td.dataset.col;
        socket.emit('stamp', { code, playerId: '<%= currentPlayer.id %>', row, col });
      });
    });

    function startNewGame(code) {
      socket.emit('new_game', { code });
    }
  </script>
</body>
</html>